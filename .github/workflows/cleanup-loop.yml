name: shinto-cleanup-loop

on:
  workflow_dispatch:
  push:
    paths-ignore:
      - "**/*.state"
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      WIKI_USERNAME: ${{ vars.WIKI_USERNAME }}
      WIKI_PASSWORD: ${{ secrets.WIKI_PASSWORD }}
      WIKI_EDIT_LIMIT: "1000"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install mwclient requests

      - name: Validate required secrets
        run: |
          if [ -z "${WIKI_USERNAME}" ] || [ -z "${WIKI_PASSWORD}" ]; then
            echo "WIKI_USERNAME variable and WIKI_PASSWORD secret are required."
            exit 1
          fi
          if [[ "${WIKI_USERNAME}" != *"@"* ]]; then
            echo "WIKI_USERNAME must use bot-password format, e.g. EmmaBot@EmmaBot."
            exit 1
          fi

      - name: Run cleanup loop
        run: |
          chmod +x shinto_miraheze/cleanup_loop.sh
          shinto_miraheze/cleanup_loop.sh

      - name: Commit updated state files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A -- "*.state"
          if git diff --cached --quiet; then
            echo "No state changes to commit."
            exit 0
          fi
          git commit -m "chore(state): update bot state files [skip ci]"
          git push origin "HEAD:${GITHUB_REF_NAME}"
